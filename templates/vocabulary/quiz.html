{% extends "vocabulary/base_vocab.html" %}

{% block title %}Quiz - Sophia's Vocabulary Trainer{% endblock %}

{% block content %}
<div class="card">
    <h2 style="color: var(--primary-color); text-align: center; margin-bottom: 25px;">üéØ Vocabulary Quiz</h2>

    <!-- Progress indicator -->
    <div id="quiz-progress" style="margin-bottom: 20px; text-align: center;">
        <span id="question-counter" style="font-size: 1.1em; color: var(--secondary-color);"></span>
    </div>

    <div id="quiz-container">
        <div style="background: var(--accent-color); padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 25px;">
            <h3 style="font-size: 1.8em; margin-bottom: 10px;">{{ question_word.word }}</h3>
            <p style="font-size: 1.1em;">Choose the correct definition:</p>
        </div>
        
        <form id="quiz-form">
            <input type="hidden" id="word_id" value="{{ question_word.id }}">
            <div>
                {% for option in options %}
                <button type="button" class="quiz-option" data-id="{{ option.id }}">
                    {{ option.definition }}
                </button>
                {% endfor %}
            </div>
        </form>
        
        <div id="result" style="margin-top: 25px; text-align: center; display: none;">
            <p id="result-message" style="font-size: 1.3em; margin-bottom: 20px; line-height: 1.4;"></p>
            <div id="auto-advance" style="font-size: 0.9em; color: #666; margin-bottom: 15px;"></div>
            <div class="button-group">
                <button type="button" onclick="nextQuestion()" class="btn" id="next-btn">Next Question ‚û°Ô∏è</button>
                <a href="/vocabulary" class="btn btn-secondary">End Quiz</a>
            </div>
        </div>
    </div>
</div>

<style>
    .quiz-option:hover {
        border-color: var(--primary-color) !important;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .quiz-option.selected {
        border-color: var(--secondary-color) !important;
        background: var(--secondary-color) !important;
        color: white;
    }
    
    .quiz-option.correct {
        border-color: var(--success-color) !important;
        background: var(--success-color) !important;
        animation: pulse 0.5s;
    }
    
    .quiz-option.incorrect {
        border-color: #E74C3C !important;
        background: #FFCDD2 !important;
        animation: shake 0.5s;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    
    /* Confetti styles */
    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
        z-index: 9999;
        animation: fall linear;
    }
    
    @keyframes fall {
        to {
            transform: translateY(calc(100vh + 20px)) rotate(360deg);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const quizOptions = document.querySelectorAll('.quiz-option');
    let answered = false;
    let correctCount = parseInt(sessionStorage.getItem('quizCorrect') || '0');
    let totalCount = parseInt(sessionStorage.getItem('quizTotal') || '0');
    let autoAdvanceTimer = null;

    // Update question counter
    function updateQuestionCounter() {
        const currentQuestion = totalCount + 1;
        document.getElementById('question-counter').textContent = `Question ${currentQuestion} of 10`;
    }

    // Initialize on page load
    updateQuestionCounter();

    // Function to go to next question
    function nextQuestion() {
        if (autoAdvanceTimer) {
            clearTimeout(autoAdvanceTimer);
        }
        window.location.href = '/vocabulary/quiz';
    }

    quizOptions.forEach(option => {
        option.addEventListener('click', function() {
            if (answered) return;

            // Mark as selected
            quizOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');

            // Submit answer
            const wordId = document.getElementById('word_id').value;
            const answerId = this.dataset.id;

            fetch('/vocabulary/quiz/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `word_id=${wordId}&answer_id=${answerId}`
            })
            .then(response => response.json())
            .then(data => {
                answered = true;
                totalCount++;

                // Show result
                if (data.correct) {
                    this.classList.add('correct');
                    correctCount++;
                    createConfetti();
                } else {
                    this.classList.add('incorrect');
                    // Highlight correct answer
                    quizOptions.forEach(opt => {
                        if (opt.dataset.id === wordId) {
                            opt.classList.add('correct');
                        }
                    });
                }

                // Update session storage
                sessionStorage.setItem('quizCorrect', correctCount);
                sessionStorage.setItem('quizTotal', totalCount);

                // Show result message with score
                const scoreText = ` (Score: ${correctCount}/${totalCount})`;
                document.getElementById('result-message').innerHTML = data.message + '<br>' + scoreText;
                document.getElementById('result').style.display = 'block';

                // Disable all options
                quizOptions.forEach(opt => {
                    opt.style.cursor = 'default';
                    opt.disabled = true;
                });

                // Auto-advance logic
                if (totalCount < 10) {
                    document.getElementById('auto-advance').textContent = 'Auto-advancing in 3 seconds...';
                    let countdown = 3;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            document.getElementById('auto-advance').textContent = `Auto-advancing in ${countdown} seconds...`;
                        } else {
                            clearInterval(countdownInterval);
                        }
                    }, 1000);

                    autoAdvanceTimer = setTimeout(() => {
                        window.location.href = '/vocabulary/quiz';
                    }, 3000);
                } else {
                    // Quiz complete - save results
                    fetch('/vocabulary/quiz/complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `score=${correctCount}&total=${totalCount}`
                    });

                    document.getElementById('result-message').innerHTML =
                        `üéâ Quiz Complete!<br>Final Score: ${correctCount}/${totalCount} (${Math.round(correctCount/totalCount*100)}%)`;
                    document.getElementById('next-btn').textContent = 'Start New Quiz';
                    document.getElementById('next-btn').onclick = function() {
                        sessionStorage.removeItem('quizCorrect');
                        sessionStorage.removeItem('quizTotal');
                        window.location.href = '/vocabulary/quiz';
                    };
                    document.getElementById('auto-advance').style.display = 'none';
                    sessionStorage.removeItem('quizCorrect');
                    sessionStorage.removeItem('quizTotal');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    });
    
    // Improved confetti for mobile
    function createConfetti() {
        const colors = ['#FF6B6B', '#4ECDC4', '#FFD93D', '#95E1D3', '#A3BE8C', '#B48EAD'];
        const confettiCount = 30; // Fewer particles for better mobile performance
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-20px';
                confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                
                document.body.appendChild(confetti);
                
                confetti.addEventListener('animationend', () => confetti.remove());
            }, i * 30); // Stagger creation for better effect
        }
    }
</script>
{% endblock %}